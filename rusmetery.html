<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/fabric@latest/dist/index.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <div class="topnav">
    <a href="javascript:void(0);" class="icon" onclick="myFunction()">
      <i class="fa fa-bars"></i>
    </a>
    <a href="#home" class="active">Logo</a>
    <!-- Navigation links (hidden by default) -->
    <div id="myLinks"><table>    
      <!--<a href="#news">News</a>
      <a href="#contact">Contact</a>
      <a href="#about">About</a>-->

      <tr>
      <td></td>
      <td id="FBTNS">
        <input type="button" id="9FBTN" value="9F">
        <input type="button" id="10FBTN" value="10F">
        <input type="button" id="11FBTN" value="11F">
        <input type="button" id="12FBTN" value="12F">
      </td>
      </tr>

      <tr>
      <td><label style="color:white">Table Width</label></td>
      <td><input type="number" id="TABLE_WIDTH"></td>
      </tr>
      
      <tr>
      <td><label style="color:white">Table Height</label></td>
      <td><input type="number" id="TABLE_HEIGHT"></td>
      </tr>

      <tr>
      <td><label style="color:white">Balls D</label></td>
      <td><input type="number" id="BALLS_D"></td>
      </tr>

      <tr>
      <td><label style="color:white">Pocket D</label></td>
      <td><input type="number" id="POCKET_D"></td>
      </tr>

      <tr>
      <td><label style="color:white">Balls Angle</label></td>
      <td><input type="number" id="BALLS_ANGLE"></td>
      </tr>

      <tr>
      <td></td>
      <td><input type="button" id="OK" value="OK"></td>
      </tr>
    
    </table></div>
  </div>

  <style>
    /* Style the navigation menu */
    .topnav {
      overflow: hidden;
      background-color: #333;
      position: relative;
    }

    /* Hide the links inside the navigation menu (except for logo/home) */
    .topnav #myLinks {
      display: none;
    }

    /* Style navigation menu links */
    .topnav a {
      color: white;
      padding: 14px 16px;
      text-decoration: none;
      font-size: 17px;
      display: block;
    }

    /* Style the hamburger menu */
    .topnav a.icon {
      background: black;
      display: block;
      position: absolute;
      right: 0;
      top: 0;
    }

    /* Add a grey background color on mouse-over */
    .topnav a:hover {
      background-color: #ddd;
      color: black;
    }

    /* Style the active link (or home/logo) */
    .active {
      background-color: #04AA6D;
      color: white;
    }
  </style>
</head>

<body>
    <canvas id="canvas" width="800" height="450" style="border:1px solid #000000"></canvas>
    <script>

        const degreesToRads = deg => (deg * Math.PI) / 180.0;
        const radsToDegrees = rad => (rad * 180.0) / Math.PI;
        const EPS =  14e-88;

        function inteceptCircleLineSeg(circle, line)
        {
          var a, b, c, d, u1, u2, ret, retP1, retP2, v1, v2;
          v1 = {};
          v2 = {};
          v1.x = line.p2.x - line.p1.x;
          v1.y = line.p2.y - line.p1.y;
          v2.x = line.p1.x - circle.center.x;
          v2.y = line.p1.y - circle.center.y;
          b = (v1.x * v2.x + v1.y * v2.y);
          c = 2 * (v1.x * v1.x + v1.y * v1.y);
          b *= -2;
          d = Math.sqrt(b * b - 2 * c * (v2.x * v2.x + v2.y * v2.y - circle.radius * circle.radius));
          if(isNaN(d)){ // no intercept
              return [];
          }
          u1 = (b - d) / c;  // these represent the unit distance of point one and two on the line
          u2 = (b + d) / c;    
          retP1 = {};   // return points
          retP2 = {}  
          ret = []; // return array
          if(u1 <= 1 && u1 >= 0){  // add point if on the line segment
              retP1.x = line.p1.x + v1.x * u1;
              retP1.y = line.p1.y + v1.y * u1;
              ret[0] = retP1;
          }
          if(u2 <= 1 && u2 >= 0){  // second add point if on the line segment
              retP2.x = line.p1.x + v1.x * u2;
              retP2.y = line.p1.y + v1.y * u2;
              ret[ret.length] = retP2;
          }       
          return ret;
        }

        // init first time
        if( !sessionStorage.tableWidth ) sessionStorage.tableWidth = 3500;
        if( !sessionStorage.tableHeight ) sessionStorage.tableHeight = 1750;
        if( !sessionStorage.ballsD ) sessionStorage.ballsD = 68;
        if( !sessionStorage.pocketD ) sessionStorage.pocketD = 72;
        if( !sessionStorage.ballsAngle ) sessionStorage.ballsAngle = 140;
 
        // load older settings
        document.getElementById('TABLE_WIDTH').value = sessionStorage.tableWidth;
        document.getElementById('TABLE_HEIGHT').value = sessionStorage.tableHeight;
        document.getElementById('BALLS_D').value = sessionStorage.ballsD;
        document.getElementById('POCKET_D').value = sessionStorage.pocketD;
        document.getElementById('BALLS_ANGLE').value = sessionStorage.ballsAngle;

        const TSIZE_DICT =
        {
          '9F':[2540, 1270],
          '10F':[2840, 1420],
          '11F':[3200, 1600],
          '12F':[3500, 1750],
        };

        document.getElementById('FBTNS').addEventListener('click', (e) => 
        {
          if( e.target.value in TSIZE_DICT )
          {
            var w, h;
            [w,h] = TSIZE_DICT[e.target.value]
            document.getElementById('TABLE_WIDTH').value = w;
            document.getElementById('TABLE_HEIGHT').value = h;
          }
        });


        document.getElementById('OK').addEventListener("click", ()=>
        {
          // save all settings
          sessionStorage.tableWidth = document.getElementById('TABLE_WIDTH').value;
          sessionStorage.tableHeight = document.getElementById('TABLE_HEIGHT').value;
          sessionStorage.ballsD = document.getElementById('BALLS_D').value;
          sessionStorage.pocketD = document.getElementById('POCKET_D').value;
          sessionStorage.ballsAngle = document.getElementById('BALLS_ANGLE').value;

          // and repaint with new settings
          repaint();
        });

        var canvas;

        function repaint()
        {
          if( canvas ) canvas.dispose();

          const TW = parseInt(sessionStorage.tableWidth);
          const TH = parseInt(sessionStorage.tableHeight);
          const BD = parseInt(sessionStorage.ballsD);
          const PD = parseInt(sessionStorage.pocketD);
          const BA = degreesToRads(parseInt(sessionStorage.ballsAngle));

          document.getElementById('canvas').width = TW;
          document.getElementById('canvas').height = TH;
          
          canvas = new fabric.Canvas('canvas', {backgroundColor: '#04AA6D'});
          canvas.selection = false;

          // draw lines
          const LLIST = [
            [3/4*TW,0,3/4*TW,TH,5],
            [1/4*TW,0,1/4*TW,TH,2],
            [1/2*TW,0,1/2*TW,TH,1],
            [0,TH/2,TW,TH/2,1],
          ]
          for([x1,y1,x2,y2,sw] of LLIST)
          {
            canvas.add(new fabric.Line([x1,y1,x2,y2],
            {
              strokeWidth:sw,
              stroke:'black',
              evented:false,
            }));
          }


          // draw pockets          
          const PLIST = [
            [0,0,45],
            [TW/2-PD/2,-PD/2-PD/4,0],
            [TW/2-PD/2,TH-PD/2+PD/4,0],
            [0,TH,45],
          ];
          
          for([x,y,a] of PLIST)
          {
            canvas.add(new fabric.Rect(
            {
              left:x,
              top:y-Math.sin(degreesToRads(a))*PD,
              width:PD,
              height:PD,
              angle:a,
              evented:false,
            }));
          }
          
          // white ball
          var ball = new fabric.Circle({ radius: BD/2, fill: 'white', top: TH/2-BD/2, left: TW/4-BD/2, strokeWidth:0 })
          ball.hasControls = ball.hasBorders = false;
          canvas.add(ball);

          // red ball
          var rball = new fabric.Circle({ radius: BD/2, fill: 'red', top: TH/2-BD/2, left: TW*3/4-BD/2 })
          rball.hasControls = rball.hasBorders = false;
          canvas.add(rball);

          ball.on('moving',update_lines);
          rball.on('moving',update_lines);

          var glist = [];
          
          function update_lines()
          {
            for( g of glist) canvas.remove(g);
            glist = [];

            const bcp = ball.getCenterPoint();

            var doubleRadCircle = new fabric.Circle(
            {
              radius: BD,
              fill: 'rgba(0,0,0,0)',
              stroke: 'black',
              strokeWidth: 1,
              top:ball.top-BD/2,
              left:ball.left-BD/2,
              evented:false,
            });
            canvas.add(doubleRadCircle);
            glist.push(doubleRadCircle);

            var rbcp = rball.getCenterPoint();
            // to ball null coords
            var rbx = rbcp.x-bcp.x;
            var rby = rbcp.y-bcp.y;
            var sqcdist = rbx*rbx + rby*rby;
            var cdist = Math.sqrt(sqcdist);
            var a = Math.asin(BD/2/cdist);
            // TODO? rotate coords and then back
            //var b = Math.PI - a;
            //var c = Math.atan2(rby,rbx);
            //var px = BD/2*Math.sin(c+b);
            //var py = BD/2*Math.cos(c+b);
            var px = BD/2*Math.sin(a);
            var py = BD/2*Math.cos(a);
            var py2 = -py;
            // to canvas coords
            //console.log(px, py, a,b,c);
            //console.log(c)
            px += bcp.x;
            py += bcp.y;
            py2 += bcp.y;

            // px, py, py2 - coords of two tangets to white ball

            //console.log(px, py)

            // to rball coords
            px -= rbcp.x;
            py -= rbcp.y;
            py2 -= rbcp.y;

            //console.log(px, py)

            // hz pohui
            if( px >= 0 )
            {
              k1 = Math.atan2(py,px);
              k2 = Math.atan2(py2,px);
            }
            else
            {
              k1 = Math.atan2(-py,-px);
              k2 = Math.atan2(-py2,-px);
            }

            //console.log(k1,k2)

            // longer x out of canvas
            x1 = -2*TW;
            x2 = 2*TW;
            y11 = k1*x1;
            y12 = k1*x2;

            y21 = k2*x1;
            y22 = k2*x2;

            // to canvas coords
            x1 += rbcp.x;
            x2 += rbcp.x;
            y11 += rbcp.y;
            y12 += rbcp.y;
            y21 += rbcp.y;
            y22 += rbcp.y;
            px += rbcp.x;
            py += rbcp.y;
            py2 += rbcp.y;


            // two tangent lines
            var sline = new fabric.Line([x1, y11, x2, y12],
            {
              strokeWidrth:3,
              stroke:'black',
              evented:false,
            });
            canvas.add(sline);
            glist.push(sline);

            sline = new fabric.Line([x1, y21, x2, y22],
            {
              strokeWidrth:3,
              stroke:'black',
              evented:false,
            });
            canvas.add(sline);
            glist.push(sline);


            // two intersect to pocket lines
            var res1 = inteceptCircleLineSeg({radius : BD, center : {x:bcp.x,y:bcp.y}},{p1 : {x:x1,y:y11},p2 : {x:x2,y:y12}});
            if( !res1.length ) return;
            if( res1.length > 1 ) res1[0] = res1[1];

            {
              // to res[0] coords
              rbx = rbcp.x - res1[0].x
              rby = rbcp.y - res1[0].y

              a = Math.atan2(rby,rbx);
              a += BA;
              x = -TW;
              y = Math.tan(a)*x;

              // to canvas from res[0] coords
              x += res1[0].x;
              y += res1[0].y

              // TODO? phantom ball on the intersect point
              sline = new fabric.Line([res1[0].x, res1[0].y, x, y],
              {
                strokeWidrth:3,
                stroke:'black',
                evented:false,
              });
              canvas.add(sline);
              glist.push(sline);
            }


            var res2 = inteceptCircleLineSeg({radius : BD, center : {x:bcp.x,y:bcp.y}},{p1 : {x:x1,y:y21},p2 : {x:x2,y:y22}});
            if( !res2.length ) return;
            if( res2.length > 1 ) res2[0] = res2[1];

            {
              // to res[0] coords
              rbx = rbcp.x - res2[0].x
              rby = rbcp.y - res2[0].y

              a = Math.atan2(rby,rbx);
              a -= BA;
              x = -TW;
              y = Math.tan(a)*x;

              // to canvas from res[0] coords
              x += res2[0].x;
              y += res2[0].y

              // TODO? phantom ball on the intersect point
              sline = new fabric.Line([res2[0].x, res2[0].y, x, y],
              {
                strokeWidrth:3,
                stroke:'black',
                evented:false,
              });
              canvas.add(sline);
              glist.push(sline);
            }



            //console.log(b.getCenterPoint());
            //console.log(rbx, rby, px, py);
            
            
            /*var point = new fabric.Line([ball.left, ball.top, ball.left+EPS, ball.top+EPS],
            {
              strokeWidrth:3,
              stroke:'black',
              evented:false,
            });
            glist.push(point);
            canvas.add(point);*/

            //console.log(ball);
            //console.log(ball.top);
            //console.log(bcp.x, bcp.y);
          };
        }
        
        /*canvas.selectionColor = 'rgba(0,255,0,0.3)';
        canvas.selectionBorderColor = 'red';
        canvas.selectionLineWidth = 5;*/

        /* Toggle between showing and hiding the navigation menu links when the user clicks on the hamburger menu / bar icon */
        function myFunction() {
          var x = document.getElementById("myLinks");
          if (x.style.display === "block") {
            x.style.display = "none";
          } else {
            x.style.display = "block";
          }
        }

        document.getElementById('OK').click()
    </script>
</body>
</html>